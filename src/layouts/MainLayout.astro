---
import { ViewTransitions } from "astro:transitions";
import { Toaster } from "../components/ui/toaster";
import { createSupabaseServer } from "@/lib/supabase";

interface Props {
  title: string;
}

const { title } = Astro.props;

// Get initial user state
const supabase = createSupabaseServer({
  get: (name) => Astro.cookies.get(name)?.value,
  set: (name, value, options) => Astro.cookies.set(name, value, options),
});

const {
  data: { user },
} = await supabase.auth.getUser();

const userData = JSON.stringify(user);
---

<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <ViewTransitions />
  </head>
  <body class="h-full">
    <main class="min-h-full">
      <slot />
    </main>
    <Toaster client:load />
    <script type="application/json" id="user-data" set:html={userData} />
    <script is:inline>
      // Handle auth on page load and transitions
      function handleAuth() {
        const currentPath = window.location.pathname;
        const isAuthPage = ["/login", "/register", "/reset-password"].includes(currentPath);
        const hasAuthToken = document.cookie.includes("sb-access-token");

        if (!hasAuthToken && !isAuthPage && currentPath !== "/") {
          window.location.href = "/login";
          return;
        }

        if (hasAuthToken && isAuthPage) {
          window.location.href = "/generate";
          return;
        }

        const userDataElement = document.getElementById("user-data");
        if (!userDataElement?.textContent) return;

        try {
          const parsedUserData = JSON.parse(userDataElement.textContent);
          if (!parsedUserData) return;

          console.log("Reinitializing auth store after page transition:", parsedUserData);
          window.dispatchEvent(new CustomEvent("auth:login", { detail: { user: parsedUserData } }));
        } catch (error) {
          console.error("Failed to parse user data:", error);
        }
      }

      // Initial auth check
      handleAuth();

      // Check auth on page transitions
      document.addEventListener("astro:page-load", handleAuth);
    </script>
  </body>
</html>
